#SPDX-License-Identifier: MIT-0
---
# tasks file for listmonk
  - name: Check prerequisites
    ansible.builtin.include_tasks: prereqs.yml
    tags:
      - prereqs
      - always

  - name: Check for deprecations
    ansible.builtin.include_tasks: deprecations.yml
    tags:
      - always

  - name: Distro specific tasks
    ansible.builtin.include_tasks: "{{ ansible_os_family | lower }}.yml"
    tags:
      - unbound

  - name: Include install tasks
    ansible.builtin.include_tasks: install.yml
    tags:
      - install

  - name: Include systemd tasks
    ansible.builtin.include_tasks: systemd.yml
    tags:
      - systemd

  - name: Include config.toml file tasks
    when: listmonk.service_start_with_config
    ansible.builtin.include_tasks: config_store.yml
    tags:
      - install

  - name: Check if Listmonk was bootstrapped using ansible_local fact
    ansible.builtin.set_fact:
      listmonk_already_bootstrapped: "{{ ansible_local.listmonk.general.bootstrapped | default(false) }}"

  - name: Ensure PostgreSQL is available
    block:
      - name: Wait for PostgreSQL to be available
        ansible.builtin.wait_for:
          host: "{{ listmonk_config_db_host }}"
          port: "{{ listmonk_config_db_port }}"
          state: started
          timeout: 60
          delay: 5
        become: true
    rescue:
      - name: Fail and show that PostgreSQL is unreachable
        ansible.builtin.fail:
          msg: "âŒ Aborting: Could not connect to PostgreSQL at {{ listmonk_config_db_host }}:{{ listmonk_config_db_port }}."

  - name: Force install of database scheme once and create API user
    shell: >
      {{ listmonk.home }}/bin/listmonk --config {{ listmonk.config_dir }}/config.toml --install --idempotent --yes 2>&1
    environment:
      LISTMONK_ADMIN_USER: "{{ listmonk_bootstrap_LISTMONK_ADMIN_USER }}"
      LISTMONK_ADMIN_PASSWORD: "{{ listmonk_bootstrap_LISTMONK_ADMIN_PASSWORD }}"
      LISTMONK_ADMIN_API_USER: "{{ listmonk_bootstrap_LISTMONK_ADMIN_API_USER }}"
    register: listmonk_bootstrap_output
    when: not listmonk_already_bootstrapped
    no_log: "{{ not debug_mode | default(false) }}"

  - name: Debug listmonk install output (dev only)
    debug:
      var: listmonk_bootstrap_output.stdout_lines
    when: debug_mode | default(false)

  - name: Find line containing API token
    set_fact:
      listmonk_api_token_line: >-
        {{
          (listmonk_bootstrap_output.stdout_lines
           | select('search', 'LISTMONK_ADMIN_API_TOKEN=')
           | list
          ) | first | default('')
        }}
    when:
      - not listmonk_already_bootstrapped
      - listmonk.override_settings
    no_log: "{{ not debug_mode | default(false) }}"

  - name: Extract API token from found line using split
    set_fact:
      listmonk_api_token: "{{ (listmonk_api_token_line.split('LISTMONK_ADMIN_API_TOKEN=\"')[1].split('\"')[0]).strip() if 'LISTMONK_ADMIN_API_TOKEN=\"' in listmonk_api_token_line else '' }}"
    when:
      - not listmonk_already_bootstrapped
      - listmonk.override_settings
      - listmonk_api_token_line != ''
      - listmonk_api_token_line.count('"') >= 2
    no_log: "{{ not debug_mode | default(false) }}"

  - name: Fail if API token was not found in install output
    fail:
      msg: >
        Failed to extract API token from Listmonk install output.
        Make sure the install created the API user and printed the token.
    when:
      - not listmonk_already_bootstrapped
      - listmonk.override_settings
      - listmonk_api_token is not defined or listmonk_api_token == ""
    no_log: "{{ not debug_mode | default(false) }}"

  - name: Show curl equivalent for Listmonk settings API
    debug:
      msg: >
        curl -X PUT "{{ listmonk.api_url }}/settings"
        -H "Authorization: token {{ listmonk_bootstrap_LISTMONK_ADMIN_API_USER }}:{{ listmonk_api_token }}"
        -H "Content-Type: application/json"
        -d '{{ listmonk.api_settings_payload | to_json }}'
    when: debug_mode | default(false)

  - name: Configure Listmonk settings via API
    uri:
      url: "{{ listmonk.api_url }}/settings"
      method: PUT
      headers:
        Authorization: "token {{ listmonk_bootstrap_LISTMONK_ADMIN_API_USER }}:{{ listmonk_api_token }}"
        Content-Type: "application/json"
      body_format: raw
      body: "{{ listmonk.api_settings_payload | to_json }}"
      status_code: 200
    when:
      - listmonk.override_settings
      - listmonk_api_token is defined and listmonk_api_token | length > 0
    no_log: "{{ not debug_mode | default(false) }}"

  - name: Flush pending handlers
    ansible.builtin.meta: flush_handlers

  - name: "Start and wait for listmonk service"
    ansible.builtin.include_tasks: start.yml

  - name: Check service status
    ansible.builtin.systemd_service:
      name: "{{ listmonk.service_name }}"
    register: listmonk_service_status
    changed_when: false

  - name: "Notify that setup was bootstrapped successfully"
    when:
      - not ansible_local.listmonk.general.bootstrapped | default(false) | bool # it was not bootstrapped prior to the current role's execution
      - listmonk_service_status.status.ActiveState == "active"                  # but it is now
    ansible.builtin.debug:
      msg: "Setup bootstrapped successfully"
    changed_when: true
    notify:
      - bootstrapped

  - name: Get full systemctl status output
    ansible.builtin.command: "systemctl status {{ listmonk.service_name }}"
    register: listmonk_systemctl_output
    changed_when: false
    failed_when: false
    when:
      - listmonk_service_status.status.ActiveState != "active"

  - name: Assert listmonk service is active, else print systemctl status
    ansible.builtin.assert:
      that:
        - listmonk_service_status.status.ActiveState == "active"
      fail_msg: |
        The {{ listmonk.service_name }} service is NOT active.
        
        systemctl status output:
        {{ listmonk_systemctl_output.stdout | default('No systemctl output available') }}
    changed_when: false

  - name: Flush pending handlers
    ansible.builtin.meta: flush_handlers
